// ========================================
// ê²Œì„ í•µì‹¬ ë¡œì§ (game-core.js) - ë³´ìŠ¤ ì‹œìŠ¤í…œ ë° ëŒ€í˜• ë¯¸ì‚¬ì¼ êµ¬í˜„ ë²„ì „
// ========================================

// ê²Œì„ ìƒíƒœ ê´€ë¦¬
let gameRunning = false;
let gamePaused = false;
let score = 0;
let lives = 5;
let currentStage = 1;
let currentPlanet = 1; // í˜„ì¬ í–‰ì„± (1-5)
let isFullscreen = false;
let selectedCharacter = 'ê¸°ë³¸'; // ì„ íƒëœ ìºë¦­í„°
let gameDifficulty = 'ë³´í†µ'; // ê²Œì„ ë‚œì´ë„
let isDashing = false; // ëŒ€ì‹œ ìƒíƒœ
let bossStage = false; // ë³´ìŠ¤ ìŠ¤í…Œì´ì§€ ì—¬ë¶€
let bossDefeated = false; // ë³´ìŠ¤ ì²˜ì¹˜ ì—¬ë¶€

// ì‹œê°„ ì‹œìŠ¤í…œ
let gameTime = 0; // ê²Œì„ ì‹œì‘ í›„ ê²½ê³¼ ì‹œê°„ (ì´ˆ)
let isNightMode = false; // ì €ë… ëª¨ë“œ ì—¬ë¶€
let nightModeTimer = 0; // ì €ë… ëª¨ë“œ ì§€ì† ì‹œê°„
let lastTimeTransition = 0; // ë§ˆì§€ë§‰ ì‹œê°„ ì „í™˜ ì‹œì 

// ê²Œì„ ì„¤ì •
const GRAVITY = 0.8;
const JUMP_POWER = 18;
const MOVE_SPEED = 6;
const DASH_SPEED = 12; // ëŒ€ì‹œ ì†ë„
const STAGE_WIDTH = 8000; // ë§µ í¬ê¸° ëŒ€í­ ì¦ê°€

// ìºë¦­í„° ëŠ¥ë ¥ì¹˜ ì •ì˜
const CHARACTER_STATS = {
    'ê¸°ë³¸': {
        health: 300,
        attackPower: 50,
        speed: 6,
        jumpPower: 18
    },
    'ê²€ì‚¬': {
        health: 250,
        attackPower: 80,
        speed: 5,
        jumpPower: 16
    },
    'ê¶ìˆ˜': {
        health: 200,
        attackPower: 60,
        speed: 7,
        jumpPower: 20
    },
    'ë§ì¹˜ì „ë¬¸ê°€': {
        health: 350,
        attackPower: 90,
        speed: 4,
        jumpPower: 15
    },
    'í­íƒ„ì „ë¬¸ê°€': {
        health: 180,
        attackPower: 100,
        speed: 8,
        jumpPower: 22
    }
};

// ê²Œì„ ê°ì²´ ë°°ì—´ë“¤
let platforms = [];
let enemies = [];
let coins = [];
let particles = [];
let explosions = [];
let cameraX = 0;
let stageProgress = 0;
let stageComplete = false;

// í”Œë ˆì´ì–´ ê°ì²´
let player = {
    x: 100,
    y: 800,
    width: 40,
    height: 60,
    velocityX: 0,
    velocityY: 0,
    health: 300,
    maxHealth: 300,
    attackPower: 50,
    speed: 6,
    jumpPower: 18,
    character: 'ê¸°ë³¸',
    attacking: false,
    attackCooldown: 0,
    invincible: false,
    invincibleTime: 0,
    onGround: false,
    jumping: false,
    jumpCount: 0,
    direction: 1,
    projectiles: []
};

// ë‚œì´ë„ ì„¤ì •
const DIFFICULTY_SETTINGS = {
    'ì‰¬ì›€': {
        lives: 7,
        playerHealth: 1.2,
        enemyHealth: 0.8,
        enemySpeed: 0.8,
        enemyAttack: 0.8
    },
    'ë³´í†µ': {
        lives: 5,
        playerHealth: 1.0,
        enemyHealth: 1.0,
        enemySpeed: 1.0,
        enemyAttack: 1.0
    },
    'ì–´ë ¤ì›€': {
        lives: 3,
        playerHealth: 0.8,
        enemyHealth: 1.3,
        enemySpeed: 1.2,
        enemyAttack: 1.3
    }
};

// í–‰ì„± í…Œë§ˆ ì„¤ì •
const PLANET_THEMES = {
    1: { // ë‚˜ë¬´í–‰ì„± (1-20ìŠ¤í…Œì´ì§€)
        name: 'ğŸŒ³ ë‚˜ë¬´í–‰ì„±',
        background: {
            sky: ['#4A90E2', '#7FB3D3', '#B8D4E3', '#E8F4F8'],
            mountains: ['#228B22', '#32CD32', '#90EE90'],
            ground: '#8B4513',
            platforms: '#228B22'
        },
        enemies: ['ë‚˜ë¬´ëŒì´', 'ë‚˜ë¬´ì™•', 'í¬íƒ‘ëª¬'],
        boss: 'ğŸŒ³ ê±°ëŒ€ë‚˜ë¬´ì™•',
        stageRange: [1, 20],
        ground: '#8B4513',
        coin: '#FFD700'
    },
    2: { // ë¶ˆê½ƒí–‰ì„± (21-40ìŠ¤í…Œì´ì§€)
        name: 'ğŸ”¥ ë¶ˆê½ƒí–‰ì„±',
        background: {
            sky: ['#FF4500', '#FF6347', '#FF7F50', '#FFA07A'],
            mountains: ['#8B0000', '#DC143C', '#FF1493'],
            ground: '#8B0000',
            platforms: '#DC143C'
        },
        enemies: ['ë¶ˆëŒì´', 'ë¶ˆì™•', 'ìš©ì•”ëª¬'],
        boss: 'ğŸ”¥ ê±°ëŒ€ë¶ˆì™•',
        stageRange: [21, 40],
        ground: '#8B0000',
        coin: '#FF4500'
    },
    3: { // ë²ˆê°œí–‰ì„± (41-60ìŠ¤í…Œì´ì§€)
        name: 'âš¡ ë²ˆê°œí–‰ì„±',
        background: {
            sky: ['#4169E1', '#6495ED', '#87CEEB', '#B0E0E6'],
            mountains: ['#191970', '#483D8B', '#6A5ACD'],
            ground: '#191970',
            platforms: '#483D8B'
        },
        enemies: ['ë²ˆê°œëŒì´', 'ë²ˆê°œì™•', 'ì „ê¸°ëª¬'],
        boss: 'âš¡ ê±°ëŒ€ë²ˆê°œì™•',
        stageRange: [41, 60],
        ground: '#191970',
        coin: '#4169E1'
    },
    4: { // ì›ì†Œí–‰ì„± (61-80ìŠ¤í…Œì´ì§€)
        name: 'ğŸŒˆ ì›ì†Œí–‰ì„±',
        background: {
            sky: ['#9932CC', '#BA55D3', '#DDA0DD', '#E6E6FA'],
            mountains: ['#4B0082', '#800080', '#9370DB'],
            ground: '#4B0082',
            platforms: '#800080'
        },
        enemies: ['ì›ì†ŒëŒì´', 'ì›ì†Œì™•', 'ë§ˆë²•ëª¬'],
        boss: 'ğŸŒˆ ê±°ëŒ€ì›ì†Œì™•',
        stageRange: [61, 80],
        ground: '#4B0082',
        coin: '#8A2BE2'
    },
    5: { // ì–¼ìŒí–‰ì„± (81-100ìŠ¤í…Œì´ì§€)
        name: 'â„ï¸ ì–¼ìŒí–‰ì„±',
        background: {
            sky: ['#87CEEB', '#B0E0E6', '#E0FFFF', '#F0F8FF'],
            mountains: ['#4682B4', '#5F9EA0', '#B0C4DE'],
            ground: '#4682B4',
            platforms: '#5F9EA0'
        },
        enemies: ['ì–¼ìŒëŒì´', 'ì–¼ìŒì™•', 'ëˆˆì‚¬ëŒëª¬'],
        boss: 'â„ï¸ ê±°ëŒ€ì–¼ìŒì™•',
        stageRange: [81, 100],
        ground: '#4682B4',
        coin: '#87CEEB'
    }
};

// 14ê°œ ìºë¦­í„° ëŠ¥ë ¥ì¹˜ ë° ìŠ¤í‚¬ ì‹œìŠ¤í…œ
const CHARACTERS = {
    'ê¸°ë³¸': {
        name: 'ê¸°ë³¸',
        emoji: 'ğŸ‘¤',
        description: 'ê· í˜•ì¡íŒ ëŠ¥ë ¥ì¹˜',
        stats: {
            health: 300,
            attack: 50,
            speed: 6,
            jumpPower: 18
        },
        specialAbility: 'ì—†ìŒ',
        specialSkill: 'ì—†ìŒ'
    },
    'ê²€ì‚¬': {
        name: 'ê²€ì‚¬',
        emoji: 'âš”ï¸',
        description: 'ë†’ì€ ê³µê²©ë ¥',
        stats: {
            health: 250,
            attack: 80,
            speed: 5,
            jumpPower: 16
        },
        specialAbility: 'ê²€ê¸° ë°œì‚¬',
        specialSkill: 'ê²€ê¸° í­í’'
    },
    'ê¶ìˆ˜': {
        name: 'ê¶ìˆ˜',
        emoji: 'ğŸ¹',
        description: 'ì›ê±°ë¦¬ ê³µê²©',
        stats: {
            health: 200,
            attack: 60,
            speed: 7,
            jumpPower: 20
        },
        specialAbility: 'í™”ì‚´ ë°œì‚¬',
        specialSkill: 'í™”ì‚´ í­í’'
    },
    'ë§ì¹˜ì „ë¬¸ê°€': {
        name: 'ë§ì¹˜ì „ë¬¸ê°€',
        emoji: 'ğŸ”¨',
        description: 'íŒŒê´´ì˜ ë‹¬ì¸',
        stats: {
            health: 350,
            attack: 90,
            speed: 4,
            jumpPower: 14
        },
        specialAbility: 'ë§ì¹˜ ë˜ì§€ê¸°',
        specialSkill: 'ì§€ì§„'
    },
    'í­íƒ„ì „ë¬¸ê°€': {
        name: 'í­íƒ„ì „ë¬¸ê°€',
        emoji: 'ğŸ’£',
        description: 'í­ë°œ ì „ë¬¸ê°€',
        stats: {
            health: 180,
            attack: 100,
            speed: 8,
            jumpPower: 22
        },
        specialAbility: 'í­íƒ„ ì„¤ì¹˜',
        specialSkill: 'í­ë°œ'
    },
    'ë¯¸ì‚¬ì¼ë°œì‚¬ë‹¬ì¸': {
        name: 'ë¯¸ì‚¬ì¼ë°œì‚¬ë‹¬ì¸',
        emoji: 'ğŸš€',
        description: 'ì •ë°€ íƒ€ê²©',
        stats: {
            health: 220,
            attack: 85,
            speed: 6,
            jumpPower: 18
        },
        specialAbility: 'ë¯¸ì‚¬ì¼ ë°œì‚¬',
        specialSkill: 'ë¯¸ì‚¬ì¼ í­ê²©'
    },
    'í’ì„ ': {
        name: 'í’ì„ ',
        emoji: 'ğŸˆ',
        description: 'ê°€ë²¼ìš´ ëª¸',
        stats: {
            health: 150,
            attack: 40,
            speed: 9,
            jumpPower: 25
        },
        specialAbility: 'ê³µì¤‘ ë¶€ìœ ',
        specialSkill: 'í’ì„  í­ë°œ'
    },
    'ì™•': {
        name: 'ì™•',
        emoji: 'ğŸ‘‘',
        description: 'ì™•ì˜ ê¶Œìœ„',
        stats: {
            health: 400,
            attack: 70,
            speed: 5,
            jumpPower: 16
        },
        specialAbility: 'ì™•ì˜ ëª…ë ¹',
        specialSkill: 'ì™•ì˜ ë¶„ë…¸'
    },
    'ìŠ¤í”¼ì–´ë§¨': {
        name: 'ìŠ¤í”¼ì–´ë§¨',
        emoji: 'ğŸ”±',
        description: 'ì°½ìˆ  ë‹¬ì¸',
        stats: {
            health: 280,
            attack: 75,
            speed: 6,
            jumpPower: 17
        },
        specialAbility: 'ì°½ ë˜ì§€ê¸°',
        specialSkill: 'ì°½ì˜ í­í’'
    },
    'ì–´ë‘ ì˜ë§ˆë²•ì‚¬': {
        name: 'ì–´ë‘ ì˜ë§ˆë²•ì‚¬',
        emoji: 'ğŸŒ‘',
        description: 'ì–´ë‘ ì˜ í˜',
        stats: {
            health: 200,
            attack: 95,
            speed: 5,
            jumpPower: 15
        },
        specialAbility: 'ì–´ë‘ ì˜ í˜',
        specialSkill: 'ì–´ë‘ ì˜ í­í’'
    },
    'ë§ˆë²•ì‚¬': {
        name: 'ë§ˆë²•ì‚¬',
        emoji: 'ğŸ”®',
        description: 'ë§ˆë²• ì „ë¬¸ê°€',
        stats: {
            health: 180,
            attack: 90,
            speed: 6,
            jumpPower: 18
        },
        specialAbility: 'ë§ˆë²• ë°œì‚¬',
        specialSkill: 'ë§ˆë²• í­í’'
    },
    'ë°œí‚¤ë¦¬': {
        name: 'ë°œí‚¤ë¦¬',
        emoji: 'ğŸ›¡ï¸',
        description: 'ì‹ ì˜ í˜',
        stats: {
            health: 400,
            attack: 45,
            speed: 6,
            jumpPower: 19
        },
        specialAbility: 'ì‹ ì˜ í˜',
        specialSkill: 'ì‹ ì˜ í­í’'
    },
    'ë°©íŒ¨ë§¨': {
        name: 'ë°©íŒ¨ë§¨',
        emoji: 'ğŸ›¡ï¸',
        description: 'ì² ë²½ ë°©ì–´',
        stats: {
            health: 450,
            attack: 35,
            speed: 4,
            jumpPower: 14
        },
        specialAbility: 'ì² ë²½ ë°©ì–´',
        specialSkill: 'ë°©íŒ¨ ëŒì§„'
    },
    'ê±°ì¸': {
        name: 'ê±°ì¸',
        emoji: 'ğŸ‘¹',
        description: 'ê±°ëŒ€í•œ í˜',
        stats: {
            health: 500,
            attack: 40,
            speed: 3,
            jumpPower: 12
        },
        specialAbility: 'ê±°ëŒ€í•œ í˜',
        specialSkill: 'ê±°ì¸ì˜ ë¶„ë…¸'
    },
    'ë¯¸ì‚¬ì¼': {
        name: 'ë¯¸ì‚¬ì¼',
        emoji: 'ğŸš€',
        description: 'ì´ˆê³ ì†',
        stats: {
            health: 120,
            attack: 60,
            speed: 10,
            jumpPower: 28
        },
        specialAbility: 'ì´ˆê³ ì†',
        specialSkill: 'ì´ˆê³ ì† ëŒì§„'
    }
};

// ë‚œì´ë„ë³„ ì„¤ì • (ê¸°ì¡´ ì„ ì–¸ê³¼ í†µí•©)

// í‚¤ë³´ë“œ ì…ë ¥ ìƒíƒœ
const keys = {};

// ê²Œì„ ì´ˆê¸°í™” (DOM ë¡œë“œ í›„ ìë™ ì‹¤í–‰)
function setupGame() {
    console.log('ê²Œì„ ì„¤ì • ì‹œì‘...');
    
    try {
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        if (typeof setupEventListeners === 'function') {
            setupEventListeners();
        } else {
            console.error('setupEventListeners í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }
        
        // ì „ì²´í™”ë©´ ê¸°ëŠ¥ ì´ˆê¸°í™”
        if (typeof initFullscreen === 'function') {
            initFullscreen();
        } else {
            console.error('initFullscreen í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }
        
        // ê²Œì„ ì‹œì‘ í™”ë©´ í‘œì‹œ
        if (typeof showStartScreen === 'function') {
            showStartScreen();
        } else {
            console.error('showStartScreen í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }
        
        // ê²Œì„ ì‹œì‘ ì „ ë°°ê²½ ìŒì•… ì¬ìƒ
        if (window.audioSystem && window.audioSystem.playTitleMusic) {
            console.log('ğŸµ ê²Œì„ ì‹œì‘ ì „ ë°°ê²½ ìŒì•… ì¬ìƒ ì‹œë„...');
            window.audioSystem.playTitleMusic();
        } else {
            console.warn('ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        
        console.log('ê²Œì„ ì„¤ì • ì™„ë£Œ!');
    } catch (error) {
        console.error('setupGame ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    }
}

// DOM ë¡œë“œ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ setupGame ì‹¤í–‰ (ì§€ì—° ì‹¤í–‰ìœ¼ë¡œ ë³€ê²½)
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        console.log('game-core.js: DOM ë¡œë“œ ì™„ë£Œ, setupGame ì§€ì—° ì‹¤í–‰...');
        // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ë“¤ì´ ë¡œë“œë  ì‹œê°„ì„ ì¤Œ
        setTimeout(() => {
            if (typeof setupGame === 'function') {
                setupGame();
            } else {
                console.warn('setupGame í•¨ìˆ˜ê°€ ì•„ì§ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. game.jsì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.');
            }
        }, 100);
    });
} else {
    console.log('game-core.js: DOM ì´ë¯¸ ë¡œë“œë¨, setupGame ì§€ì—° ì‹¤í–‰...');
    setTimeout(() => {
        if (typeof setupGame === 'function') {
            setupGame();
        } else {
            console.warn('setupGame í•¨ìˆ˜ê°€ ì•„ì§ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. game.jsì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.');
        }
    }, 100);
}

// ê²Œì„ ì‹œì‘ í™”ë©´ í‘œì‹œ
function showStartScreen() {
    const startScreen = document.getElementById('startScreen');
    const characterSelectScreen = document.getElementById('characterSelectScreen');
    
    if (startScreen) {
        startScreen.style.display = 'block';
        console.log('ê²Œì„ ì‹œì‘ í™”ë©´ í‘œì‹œë¨');
    }
    if (characterSelectScreen) {
        characterSelectScreen.style.display = 'none';
    }
    
    // ê²Œì„ ìº”ë²„ìŠ¤ ìˆ¨ê¸°ê¸°
    const canvas = document.getElementById('gameCanvas');
    if (canvas) {
        canvas.style.display = 'none';
    }
}

// ê²Œì„ ì‹œì‘ í•¨ìˆ˜
function startGame() {
    console.log('ê²Œì„ ì‹œì‘!');
    
    // ê²Œì„ ì‹œì‘ ì „ ë°°ê²½ ìŒì•… ì •ì§€
    if (window.audioSystem && window.audioSystem.stopTitleMusic) {
        window.audioSystem.stopTitleMusic();
    }
    
    // ìºë¦­í„° ì„ íƒ í™”ë©´ ìˆ¨ê¸°ê¸°
    const characterSelectScreen = document.getElementById('characterSelectScreen');
    if (characterSelectScreen) {
        characterSelectScreen.style.display = 'none';
    }
    
    // ê²Œì„ ìº”ë²„ìŠ¤ í‘œì‹œ
    const canvas = document.getElementById('gameCanvas');
    if (canvas) {
        canvas.style.display = 'block';
    }
    
    // ê²Œì„ ìƒíƒœ ì„¤ì •
    gameRunning = true;
    gamePaused = false;
    
    // í”Œë ˆì´ì–´ ì´ˆê¸°í™”
    initPlayer();
    
    // ìŠ¤í…Œì´ì§€ ì´ˆê¸°í™”
    initStage();
    
    // ê²Œì„ ë£¨í”„ ì‹œì‘
    gameLoop();
    
    console.log('ê²Œì„ ë£¨í”„ ì‹œì‘ë¨');
}

// ê²Œì„ ë£¨í”„
function gameLoop() {
    if (!gameRunning || gamePaused) {
        requestAnimationFrame(gameLoop);
        return;
    }
    
    // ê²Œì„ ë¡œì§ ì—…ë°ì´íŠ¸
    updateGame();
    
    // ë‹¤ìŒ í”„ë ˆì„ ìš”ì²­
    requestAnimationFrame(gameLoop);
}

// ê²Œì„ ì—…ë°ì´íŠ¸
function updateGame() {
    // í”Œë ˆì´ì–´ ì—…ë°ì´íŠ¸
    updatePlayer();
    
    // ì  ì—…ë°ì´íŠ¸
    updateEnemies();
    
    // ì½”ì¸ ì—…ë°ì´íŠ¸
    updateCoins();
    
    // íŒŒí‹°í´ ì—…ë°ì´íŠ¸
    updateParticles();
    
    // ìŠ¤í…Œì´ì§€ ì§„í–‰ë„ ì—…ë°ì´íŠ¸
    updateStageProgress();
    
    // ë Œë”ë§
    renderGame();
}

// í”Œë ˆì´ì–´ ì—…ë°ì´íŠ¸
function updatePlayer() {
    // ì¤‘ë ¥ ì ìš©
    player.velocityY += GRAVITY;
    
    // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
    player.x += player.velocityX;
    player.y += player.velocityY;
    
    // ì§€ë©´ ì¶©ëŒ í™•ì¸
    checkGroundCollision();
    
    // ê²½ê³„ í™•ì¸
    if (player.x < 0) player.x = 0;
    if (player.x > STAGE_WIDTH - player.width) player.x = STAGE_WIDTH - player.width;
    if (player.y > 900 - player.height) {
        player.y = 900 - player.height;
        player.velocityY = 0;
        player.onGround = true;
        player.jumpCount = 0;
    }
}

// ì§€ë©´ ì¶©ëŒ í™•ì¸
function checkGroundCollision() {
    player.onGround = false;
    
    for (const platform of platforms) {
        if (player.x < platform.x + platform.width &&
            player.x + player.width > platform.x &&
            player.y < platform.y + platform.height &&
            player.y + player.height > platform.y) {
            
            if (player.velocityY > 0) {
                player.y = platform.y - player.height;
                player.velocityY = 0;
                player.onGround = true;
                player.jumpCount = 0;
            }
        }
    }
}

// ì  ì—…ë°ì´íŠ¸
function updateEnemies() {
    for (const enemy of enemies) {
        // ê°„ë‹¨í•œ AI: ì¢Œìš° ì´ë™
        if (enemy.x < 400 || enemy.x > 600) {
            enemy.velocityX = enemy.velocityX || 2;
            enemy.velocityX *= -1;
        }
        enemy.x += enemy.velocityX || 2;
    }
}

// ì½”ì¸ ì—…ë°ì´íŠ¸
function updateCoins() {
    for (const coin of coins) {
        if (!coin.collected) {
            // í”Œë ˆì´ì–´ì™€ ì½”ì¸ ì¶©ëŒ í™•ì¸
            if (player.x < coin.x + coin.width &&
                player.x + player.width > coin.x &&
                player.y < coin.y + coin.height &&
                player.y + player.height > coin.y) {
                
                coin.collected = true;
                score += 100;
                console.log('ì½”ì¸ íšë“! ì ìˆ˜:', score);
            }
        }
    }
}

// íŒŒí‹°í´ ì—…ë°ì´íŠ¸
function updateParticles() {
    for (let i = particles.length - 1; i >= 0; i--) {
        const particle = particles[i];
        particle.x += particle.vx;
        particle.y += particle.vy;
        particle.life--;
        
        if (particle.life <= 0) {
            particles.splice(i, 1);
        }
    }
}

// ìŠ¤í…Œì´ì§€ ì§„í–‰ë„ ì—…ë°ì´íŠ¸
function updateStageProgress() {
    const totalCoins = coins.length;
    const collectedCoins = coins.filter(c => c.collected).length;
    const remainingEnemies = enemies.filter(e => e.health > 0).length;
    
    stageProgress = ((totalCoins - collectedCoins) / totalCoins) * 100;
    
    if (collectedCoins === totalCoins && remainingEnemies === 0) {
        stageComplete = true;
        console.log('ìŠ¤í…Œì´ì§€ ì™„ë£Œ!');
    }
}

// ê²Œì„ ë Œë”ë§
function renderGame() {
    // ìº”ë²„ìŠ¤ í´ë¦¬ì–´
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // ë°°ê²½ ê·¸ë¦¬ê¸°
    drawBackground();
    
    // í”Œë«í¼ ê·¸ë¦¬ê¸°
    drawPlatforms();
    
    // í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸°
    drawPlayer();
    
    // ì  ê·¸ë¦¬ê¸°
    drawEnemies();
    
    // ì½”ì¸ ê·¸ë¦¬ê¸°
    drawCoins();
    
    // íŒŒí‹°í´ ê·¸ë¦¬ê¸°
    drawParticles();
    
    // UI ê·¸ë¦¬ê¸°
    drawUI();
}

// ë°°ê²½ ê·¸ë¦¬ê¸°
function drawBackground() {
    // í•˜ëŠ˜ ê·¸ë¼ë°ì´ì…˜
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#87CEEB');
    gradient.addColorStop(1, '#E0F6FF');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
}

// í”Œë«í¼ ê·¸ë¦¬ê¸°
function drawPlatforms() {
    ctx.fillStyle = '#8B4513';
    for (const platform of platforms) {
        ctx.fillRect(platform.x - cameraX, platform.y, platform.width, platform.height);
    }
}

// í”Œë ˆì´ì–´ ê·¸ë¦¬ê¸°
function drawPlayer() {
    ctx.fillStyle = '#FF6B6B';
    ctx.fillRect(player.x - cameraX, player.y, player.width, player.height);
}

// ì  ê·¸ë¦¬ê¸°
function drawEnemies() {
    ctx.fillStyle = '#228B22';
    for (const enemy of enemies) {
        if (enemy.health > 0) {
            ctx.fillRect(enemy.x - cameraX, enemy.y, enemy.width, enemy.height);
        }
    }
}

// ì½”ì¸ ê·¸ë¦¬ê¸°
function drawCoins() {
    ctx.fillStyle = '#FFD700';
    for (const coin of coins) {
        if (!coin.collected) {
            ctx.fillRect(coin.x - cameraX, coin.y, coin.width, coin.height);
        }
    }
}

// íŒŒí‹°í´ ê·¸ë¦¬ê¸°
function drawParticles() {
    ctx.fillStyle = '#FF4500';
    for (const particle of particles) {
        ctx.fillRect(particle.x - cameraX, particle.y, 4, 4);
    }
}

// UI ê·¸ë¦¬ê¸°
function drawUI() {
    // ì ìˆ˜
    ctx.fillStyle = '#FFFFFF';
    ctx.font = '24px Arial';
    ctx.fillText(`ì ìˆ˜: ${score}`, 20, 40);
    
    // ìƒëª…
    ctx.fillText(`ìƒëª…: ${lives}`, 20, 70);
    
    // ìŠ¤í…Œì´ì§€
    ctx.fillText(`ìŠ¤í…Œì´ì§€: ${currentStage}`, 20, 100);
    
    // ì§„í–‰ë„
    ctx.fillText(`ì§„í–‰ë„: ${Math.round(stageProgress)}%`, 20, 130);
}

// ê²Œì„ ì¬ì‹œì‘ í•¨ìˆ˜
function restartGame() {
    console.log('ê²Œì„ ì¬ì‹œì‘!');
    
    // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
    gameRunning = false;
    gamePaused = false;
    score = 0;
    lives = 5;
    currentStage = 1;
    currentPlanet = 1;
    
    // ê²Œì„ ì‹œì‘ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    showStartScreen();
    
    // ê²Œì„ ìº”ë²„ìŠ¤ ìˆ¨ê¸°ê¸°
    const canvas = document.getElementById('gameCanvas');
    if (canvas) {
        canvas.style.display = 'none';
    }
}

// ì¼ì‹œì •ì§€ í† ê¸€
function togglePause() {
    if (gameRunning) {
        gamePaused = !gamePaused;
        console.log(gamePaused ? 'ê²Œì„ ì¼ì‹œì •ì§€' : 'ê²Œì„ ì¬ê°œ');
    }
}

// í”Œë ˆì´ì–´ ì´ˆê¸°í™”
function initPlayer() {
    console.log('í”Œë ˆì´ì–´ ì´ˆê¸°í™”...');
    
    // í”Œë ˆì´ì–´ ê¸°ë³¸ ì„¤ì •
    player.x = 100;
    player.y = 800;
    player.velocityX = 0;
    player.velocityY = 0;
    player.health = 300;
    player.maxHealth = 300;
    player.attacking = false;
    player.attackCooldown = 0;
    player.invincible = false;
    player.invincibleTime = 0;
    player.onGround = false;
    player.jumping = false;
    player.jumpCount = 0;
    player.direction = 1;
    
    // ì„ íƒëœ ìºë¦­í„°ì— ë”°ë¥¸ ëŠ¥ë ¥ì¹˜ ì„¤ì •
    if (selectedCharacter && CHARACTER_STATS[selectedCharacter]) {
        const stats = CHARACTER_STATS[selectedCharacter];
        player.health = stats.health;
        player.maxHealth = stats.health;
        player.attackPower = stats.attackPower;
        player.speed = stats.speed;
        player.jumpPower = stats.jumpPower;
        player.character = selectedCharacter;
    }
    
    console.log('í”Œë ˆì´ì–´ ì´ˆê¸°í™” ì™„ë£Œ:', player);
}

// ìŠ¤í…Œì´ì§€ ì´ˆê¸°í™”
function initStage() {
    console.log('ìŠ¤í…Œì´ì§€ ì´ˆê¸°í™”...');
    
    // ìŠ¤í…Œì´ì§€ ì§„í–‰ë„ ì´ˆê¸°í™”
    stageProgress = 0;
    stageComplete = false;
    
    // ì¹´ë©”ë¼ ìœ„ì¹˜ ì´ˆê¸°í™”
    cameraX = 0;
    
    // ê²Œì„ ê°ì²´ë“¤ ì´ˆê¸°í™”
    platforms = [];
    enemies = [];
    coins = [];
    particles = [];
    explosions = [];
    
    // í”Œë«í¼ ìƒì„±
    createPlatforms();
    
    // ì  ìƒì„±
    createEnemies();
    
    // ì½”ì¸ ìƒì„±
    createCoins();
    
    console.log('ìŠ¤í…Œì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
}

// í”Œë«í¼ ìƒì„±
function createPlatforms() {
    // ê¸°ë³¸ ì§€ë©´
    platforms.push({
        x: 0,
        y: 900,
        width: STAGE_WIDTH,
        height: 100,
        type: 'ground'
    });
    
    // ì¤‘ê°„ í”Œë«í¼ë“¤
    platforms.push({ x: 300, y: 700, width: 200, height: 20, type: 'platform' });
    platforms.push({ x: 600, y: 600, width: 200, height: 20, type: 'platform' });
    platforms.push({ x: 900, y: 500, width: 200, height: 20, type: 'platform' });
    platforms.push({ x: 1200, y: 400, width: 200, height: 20, type: 'platform' });
    
    console.log('í”Œë«í¼ ìƒì„± ì™„ë£Œ:', platforms.length);
}

// ì  ìƒì„±
function createEnemies() {
    // ë‚˜ë¬´ëŒì´ë“¤
    enemies.push({ x: 400, y: 800, width: 40, height: 60, health: 50, type: 'wood' });
    enemies.push({ x: 700, y: 700, width: 40, height: 60, health: 50, type: 'wood' });
    enemies.push({ x: 1000, y: 600, width: 40, height: 60, health: 50, type: 'wood' });
    
    console.log('ì  ìƒì„± ì™„ë£Œ:', enemies.length);
}

// ì½”ì¸ ìƒì„±
function createCoins() {
    // ì½”ì¸ë“¤
    for (let i = 0; i < 20; i++) {
        coins.push({
            x: 200 + i * 100,
            y: 800,
            width: 20,
            height: 20,
            collected: false
        });
    }
    
    console.log('ì½”ì¸ ìƒì„± ì™„ë£Œ:', coins.length);
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners() {
    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
    document.addEventListener('keydown', (e) => {
        keys[e.code] = true;
        
        // ê²Œì„ ì»¨íŠ¸ë¡¤
        if (e.code === 'Space' && gameRunning && !gamePaused) {
            e.preventDefault();
            jump();
        }
        if (e.code === 'KeyF' && gameRunning && !gamePaused) {
            e.preventDefault();
            attack();
        }
        if (e.code === 'KeyS' && gameRunning && !gamePaused) {
            e.preventDefault();
            dash();
        }
        if (e.code === 'KeyP' && gameRunning) {
            e.preventDefault();
            togglePause();
        }
        if (e.code === 'F11') {
            e.preventDefault();
            toggleFullscreen();
        }
    });
    
    document.addEventListener('keyup', (e) => {
        keys[e.code] = false;
    });
    
    console.log('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
}

// ì „ì²´í™”ë©´ ê¸°ëŠ¥ ì´ˆê¸°í™”
function initFullscreen() {
    const fullscreenToggle = document.getElementById('fullscreenToggle');
    if (fullscreenToggle) {
        fullscreenToggle.addEventListener('click', toggleFullscreen);
    }
    
    // ESC í‚¤ë¡œ ì „ì²´í™”ë©´ í•´ì œ
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);
}

// ì „ì²´í™”ë©´ í† ê¸€
function toggleFullscreen() {
    if (!isFullscreen) {
        enterFullscreen();
    } else {
        exitFullscreen();
    }
}

// ì „ì²´í™”ë©´ ì§„ì…
function enterFullscreen() {
    const gameContainer = document.getElementById('gameContainer');
    const canvas = document.getElementById('gameCanvas');
    
    if (gameContainer.requestFullscreen) {
        gameContainer.requestFullscreen();
    } else if (gameContainer.webkitRequestFullscreen) {
        gameContainer.webkitRequestFullscreen();
    } else if (gameContainer.mozRequestFullScreen) {
        gameContainer.mozRequestFullScreen();
    } else if (gameContainer.msRequestFullscreen) {
        gameContainer.msRequestFullscreen();
    }
    
    // ì „ì²´í™”ë©´ ëª¨ë“œ CSS í´ë˜ìŠ¤ ì¶”ê°€
    document.body.classList.add('fullscreen');
    isFullscreen = true;
    
    // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
    resizeCanvas();
    
    console.log('ì „ì²´í™”ë©´ ëª¨ë“œ ì§„ì…');
}

// ì „ì²´í™”ë©´ í•´ì œ
function exitFullscreen() {
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
    } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
    }
    
    // ì „ì²´í™”ë©´ ëª¨ë“œ CSS í´ë˜ìŠ¤ ì œê±°
    document.body.classList.remove('fullscreen');
    isFullscreen = false;
    
    // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
    resizeCanvas();
    
    console.log('ì „ì²´í™”ë©´ ëª¨ë“œ í•´ì œ');
}

// ì „ì²´í™”ë©´ ìƒíƒœ ë³€ê²½ ì²˜ë¦¬
function handleFullscreenChange() {
    if (!document.fullscreenElement && 
        !document.webkitFullscreenElement && 
        !document.mozFullScreenElement && 
        !document.msFullscreenElement) {
        
        // ì „ì²´í™”ë©´ì´ í•´ì œëœ ê²½ìš°
        document.body.classList.remove('fullscreen');
        isFullscreen = false;
        resizeCanvas();
        console.log('ì „ì²´í™”ë©´ ëª¨ë“œ í•´ì œë¨');
    }
}

// ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
function resizeCanvas() {
    const canvas = document.getElementById('gameCanvas');
    const gameContainer = document.getElementById('gameContainer');
    
    if (isFullscreen) {
        // ì „ì²´í™”ë©´ ëª¨ë“œ: í™”ë©´ ì „ì²´ í¬ê¸°
        canvas.style.width = '100vw';
        canvas.style.height = '100vh';
    } else {
        // ì¼ë°˜ ëª¨ë“œ: 1080p ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ í™”ë©´ì— ë§ì¶¤
        const maxWidth = window.innerWidth * 0.95;
        const maxHeight = window.innerHeight * 0.95;
        const aspectRatio = 1920 / 1080;
        
        let width = maxWidth;
        let height = width / aspectRatio;
        
        if (height > maxHeight) {
            height = maxHeight;
            width = height * aspectRatio;
        }
        
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
    }
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners() {
    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
    document.addEventListener('keydown', (e) => {
        keys[e.code] = true;
        
        // ê²Œì„ ì¤‘ì´ ì•„ë‹ ë•ŒëŠ” íŠ¹ì • í‚¤ë§Œ ì²˜ë¦¬
        if (!gameRunning) {
            if (e.code === 'Enter' || e.code === 'Space') {
                startGame();
            }
            return;
        }
        
        // ê²Œì„ ì¤‘ í‚¤ ì²˜ë¦¬
        switch(e.code) {
            case 'Space':
                e.preventDefault();
                jump();
                break;
            case 'KeyP':
                e.preventDefault();
                togglePause();
                break;
            case 'F11':
                e.preventDefault();
                toggleFullscreen();
                break;
        }
    });
    
    document.addEventListener('keyup', (e) => {
        keys[e.code] = false;
        
        // ëŒ€ì‹œ í‚¤ë¥¼ ë–¼ë©´ ëŒ€ì‹œ ìƒíƒœ í•´ì œ
        if (e.code === 'KeyS') {
            isDashing = false;
        }
    });
    
    // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸
    window.addEventListener('resize', resizeCanvas);
    
    // ë²„íŠ¼ ì´ë²¤íŠ¸
    const startButton = document.getElementById('startButton');
    const controlGuideButton = document.getElementById('controlGuideButton');
    const restartButton = document.getElementById('restartButton');
    
    if (startButton) startButton.addEventListener('click', startGame);
    if (controlGuideButton) controlGuideButton.addEventListener('click', showControlGuide);
    if (restartButton) restartButton.addEventListener('click', restartGame);
}

// ê²Œì„ ì‹œì‘
function startGame() {
    console.log('ê²Œì„ ì‹œì‘!');
    
    // UI ìˆ¨ê¸°ê¸°
    const startScreen = document.getElementById('startScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const characterSelectScreen = document.getElementById('characterSelectScreen');
    
    if (startScreen) startScreen.style.display = 'none';
    if (gameOverScreen) gameOverScreen.style.display = 'none';
    if (characterSelectScreen) characterSelectScreen.style.display = 'none';
    
    // ê²Œì„ UI í‘œì‹œ
    const gameUI = document.getElementById('gameUI');
    if (gameUI) {
        gameUI.style.display = 'block';
        console.log('ê²Œì„ UI í‘œì‹œë¨');
    }
    
    // ê²Œì„ ìº”ë²„ìŠ¤ í‘œì‹œ ë° ì´ˆê¸°í™”
    const gameCanvas = document.getElementById('gameCanvas');
    if (gameCanvas) {
        console.log('ê²Œì„ ìº”ë²„ìŠ¤ ì°¾ìŒ:', gameCanvas);
        
        // ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ ì„¤ì •
        gameCanvas.style.display = 'block';
        gameCanvas.style.position = 'relative';
        gameCanvas.style.zIndex = '100';
        
        // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
        gameCanvas.width = 1200;  // ê³ ì • ë„ˆë¹„
        gameCanvas.height = 800;  // ê³ ì • ë†’ì´
        
        // ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ í¬ê¸°
        gameCanvas.style.width = '1200px';
        gameCanvas.style.height = '800px';
        gameCanvas.style.maxWidth = '95vw';
        gameCanvas.style.maxHeight = '95vh';
        
        // ìº”ë²„ìŠ¤ ì»¨í…ìŠ¤íŠ¸ í™•ì¸ ë° ì´ˆê¸°í™”
        const ctx = gameCanvas.getContext('2d');
        if (ctx) {
            console.log('ìº”ë²„ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì„±ê³µ:', ctx);
            
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™” (ê²€ì • ë°°ê²½)
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
            
            // í…ŒìŠ¤íŠ¸ í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
            ctx.fillStyle = '#FFFFFF';
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ê²Œì„ ë¡œë”© ì¤‘...', gameCanvas.width / 2, gameCanvas.height / 2);
            
            console.log('ìº”ë²„ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
            console.error('ìº”ë²„ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì‹¤íŒ¨!');
        }
    } else {
        console.error('ê²Œì„ ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        return; // ìº”ë²„ìŠ¤ê°€ ì—†ìœ¼ë©´ ê²Œì„ ì‹œì‘ ì¤‘ë‹¨
    }
    
    // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
    gameRunning = true;
    gamePaused = false;
    score = 0;
    currentStage = 1;
    currentPlanet = 1;
    bossStage = false;
    bossDefeated = false;
    gameTime = 0;
    isNightMode = false;
    nightModeTimer = 0;
    lastTimeTransition = 0;
    
    // ë‚œì´ë„ë³„ ì„¤ì • ì ìš©
    const difficulty = DIFFICULTY_SETTINGS[gameDifficulty];
    lives = difficulty.lives;
    
    // í”Œë ˆì´ì–´ ì´ˆê¸°í™”
    resetPlayer();
    
    // ì¹´ë©”ë¼ ì´ˆê¸°í™”
    cameraX = 0;
    
    // ìŠ¤í…Œì´ì§€ ìƒì„± (ì•ˆì „í•˜ê²Œ í˜¸ì¶œ)
    if (typeof generateStage === 'function') {
        if (typeof generateStage === 'function') {
            generateStage();
        } else {
            console.warn('generateStage í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìŠ¤í…Œì´ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.');
            generateBasicStage();
        }
    
    // UI ì—…ë°ì´íŠ¸
    updateUI();
    
    // ì²« ë²ˆì§¸ í”„ë ˆì„ ì¦‰ì‹œ ë Œë”ë§
    console.log('ì²« ë²ˆì§¸ í”„ë ˆì„ ë Œë”ë§ ì‹œì‘...');
    
    // ê²Œì„ ì‹œì‘ í™”ë©´ í‘œì‹œ
    try {
        const testCanvas = document.getElementById('gameCanvas');
        const testCtx = testCanvas.getContext('2d');
        
        if (testCtx) {
            // ê¸°ë³¸ ë°°ê²½
            testCtx.fillStyle = '#87CEEB';
            testCtx.fillRect(0, 0, testCanvas.width, testCanvas.height);
            
            // ì§€ë©´
            testCtx.fillStyle = '#228B22';
            testCtx.fillRect(0, testCanvas.height - 100, testCanvas.width, 100);
            
            // ê²Œì„ ì‹œì‘ ë©”ì‹œì§€
            testCtx.fillStyle = '#FFFFFF';
            testCtx.font = 'bold 32px Arial';
            testCtx.textAlign = 'center';
            testCtx.fillText('ê²Œì„ ì‹œì‘!', testCanvas.width / 2, testCanvas.height / 2 - 50);
            testCtx.fillText(`ìºë¦­í„°: ${selectedCharacter}`, testCanvas.width / 2, testCanvas.height / 2);
            testCtx.fillText(`ë‚œì´ë„: ${gameDifficulty}`, testCanvas.width / 2, testCanvas.height / 2 + 50);
            
            console.log('ê²Œì„ ì‹œì‘ í™”ë©´ í‘œì‹œ ì™„ë£Œ');
        }
    } catch (error) {
        console.error('ê²Œì„ ì‹œì‘ í™”ë©´ ë Œë”ë§ ì˜¤ë¥˜:', error);
    }
    
    // ì ì‹œ í›„ ì‹¤ì œ ê²Œì„ ë Œë”ë§ ì‹œì‘
    setTimeout(() => {
        try {
            console.log('ì‹¤ì œ ê²Œì„ ë Œë”ë§ ì‹œì‘...');
            renderGame();
            console.log('ì²« ë²ˆì§¸ í”„ë ˆì„ ë Œë”ë§ ì™„ë£Œ');
        } catch (error) {
            console.error('ê²Œì„ ë Œë”ë§ ì˜¤ë¥˜:', error);
        }
    }, 1000); // 1ì´ˆ í›„ ì‹œì‘
    
    // ê²Œì„ ë£¨í”„ ì‹œì‘
    console.log('ê²Œì„ ë£¨í”„ ì‹œì‘...');
    gameLoop();
    
    // ê²Œì„ ë°°ê²½ìŒì•… ì¬ìƒ
    if (audioSystem && audioSystem.playGameBGM) {
        audioSystem.playGameBGM();
    }
    
    // íš¨ê³¼ìŒ ì•ˆë‚´ ë©”ì‹œì§€
    if (audioSystem && Object.keys(audioSystem.sounds).length === 0) {
        console.log('ğŸ’¡ íš¨ê³¼ìŒì´ ì—†ìŠµë‹ˆë‹¤. sfx/ í´ë”ì— .wav íŒŒì¼ì„ ì¶”ê°€í•˜ë©´ íš¨ê³¼ìŒì´ ì¬ìƒë©ë‹ˆë‹¤!');
        console.log('ğŸ’¡ ë°°ê²½ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤. bgm/ í´ë”ì— .mp3 íŒŒì¼ì„ ì¶”ê°€í•˜ë©´ ë°°ê²½ìŒì•…ì´ ì¬ìƒë©ë‹ˆë‹¤!');
    }
    
    console.log('ê²Œì„ ì‹œì‘ ì™„ë£Œ! ìº”ë²„ìŠ¤:', gameCanvas);
}

// ìŠ¤í…Œì´ì§€ ìƒì„± í•¨ìˆ˜ë“¤
function generateStage() {
    console.log('ê³ ê¸‰ ìŠ¤í…Œì´ì§€ ìƒì„±...');
    
    // í˜„ì¬ í–‰ì„±ì— ë”°ë¥¸ ìŠ¤í…Œì´ì§€ ìƒì„±
    const planetTheme = PLANET_THEMES[currentPlanet] || PLANET_THEMES[1];
    
    // í”Œë«í¼ ìƒì„±
    createPlanetPlatforms(planetTheme);
    
    // ì  ìƒì„± (generateEnemies í•¨ìˆ˜ ì‚¬ìš©)
    if (typeof generateEnemies === 'function') {
        generateEnemies();
    } else {
        createPlanetEnemies(planetTheme);
    }
    
    // ì½”ì¸ ìƒì„±
    createPlanetCoins(planetTheme);
    
    console.log('ê³ ê¸‰ ìŠ¤í…Œì´ì§€ ìƒì„± ì™„ë£Œ');
}

function generateBasicStage() {
    console.log('ê¸°ë³¸ ìŠ¤í…Œì´ì§€ ìƒì„±...');
    
    // ê¸°ë³¸ í”Œë«í¼
    platforms = [
        { x: 0, y: 900, width: STAGE_WIDTH, height: 100, type: 'ground' },
        { x: 300, y: 700, width: 200, height: 20, type: 'platform' },
        { x: 600, y: 600, width: 200, height: 20, type: 'platform' },
        { x: 900, y: 500, width: 200, height: 20, type: 'platform' },
        { x: 1200, y: 400, width: 200, height: 20, type: 'platform' }
    ];
    
    // ê¸°ë³¸ ì 
    enemies = [
        { x: 400, y: 800, width: 40, height: 60, health: 50, type: 'wood', velocityX: 2 },
        { x: 700, y: 700, width: 40, height: 60, health: 50, type: 'wood', velocityX: 2 },
        { x: 1000, y: 600, width: 40, height: 60, health: 50, type: 'wood', velocityX: 2 }
    ];
    
    // ê¸°ë³¸ ì½”ì¸
    coins = [];
    for (let i = 0; i < 20; i++) {
        coins.push({
            x: 200 + i * 100,
            y: 800,
            width: 20,
            height: 20,
            collected: false
        });
    }
    
    console.log('ê¸°ë³¸ ìŠ¤í…Œì´ì§€ ìƒì„± ì™„ë£Œ');
}

// í–‰ì„±ë³„ í”Œë«í¼ ìƒì„±
function createPlanetPlatforms(planetTheme) {
    platforms = [];
    
    // ê¸°ë³¸ ì§€ë©´
    platforms.push({
        x: 0,
        y: 900,
        width: STAGE_WIDTH,
        height: 100,
        type: 'ground',
        color: planetTheme.ground
    });
    
    // í–‰ì„±ë³„ íŠ¹ìˆ˜ í”Œë«í¼
    switch (currentPlanet) {
        case 1: // ë‚˜ë¬´í–‰ì„±
            platforms.push({ x: 300, y: 700, width: 200, height: 20, type: 'platform', color: '#228B22' });
            platforms.push({ x: 600, y: 600, width: 200, height: 20, type: 'platform', color: '#228B22' });
            break;
        case 2: // ë¶ˆê½ƒí–‰ì„±
            platforms.push({ x: 300, y: 700, width: 200, height: 20, type: 'platform', color: '#8B0000' });
            platforms.push({ x: 600, y: 600, width: 200, height: 20, type: 'platform', color: '#8B0000' });
            break;
        case 3: // ë²ˆê°œí–‰ì„±
            platforms.push({ x: 300, y: 700, width: 200, height: 20, type: 'platform', color: '#4169E1' });
            platforms.push({ x: 600, y: 600, width: 200, height: 20, type: 'platform', color: '#4169E1' });
            break;
        case 4: // ì›ì†Œí–‰ì„±
            platforms.push({ x: 300, y: 700, width: 200, height: 20, type: 'platform', color: '#8A2BE2' });
            platforms.push({ x: 600, y: 600, width: 200, height: 20, type: 'platform', color: '#8A2BE2' });
            break;
        case 5: // ì–¼ìŒí–‰ì„±
            platforms.push({ x: 300, y: 700, width: 200, height: 20, type: 'platform', color: '#87CEEB' });
            platforms.push({ x: 600, y: 600, width: 200, height: 20, type: 'platform', color: '#87CEEB' });
            break;
        default:
            platforms.push({ x: 300, y: 700, width: 200, height: 20, type: 'platform', color: '#228B22' });
            platforms.push({ x: 600, y: 600, width: 200, height: 20, type: 'platform', color: '#228B22' });
    }
}

// í–‰ì„±ë³„ ì  ìƒì„±
function createPlanetEnemies(planetTheme) {
    enemies = [];
    
    // ê¸°ë³¸ ì ë“¤
    enemies.push({ x: 400, y: 800, width: 40, height: 60, health: 50, type: 'wood', velocityX: 2 });
    enemies.push({ x: 700, y: 700, width: 40, height: 60, health: 50, type: 'wood', velocityX: 2 });
    enemies.push({ x: 1000, y: 600, width: 40, height: 60, health: 50, type: 'wood', velocityX: 2 });
    
    // í–‰ì„±ë³„ íŠ¹ìˆ˜ ì 
    if (currentPlanet === 5) { // 5ì˜ ë°°ìˆ˜ ìŠ¤í…Œì´ì§€ - ë³´ìŠ¤
        enemies.push({ x: 800, y: 600, width: 80, height: 120, health: 500, type: 'boss', velocityX: 1 });
    }
}

// í–‰ì„±ë³„ ì½”ì¸ ìƒì„±
function createPlanetCoins(planetTheme) {
    coins = [];
    
    for (let i = 0; i < 20; i++) {
        coins.push({
            x: 200 + i * 100,
            y: 800,
            width: 20,
            height: 20,
            collected: false,
            color: planetTheme.coin || '#FFD700'
        });
    }
}

// UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateUI() {
    console.log('UI ì—…ë°ì´íŠ¸...');
    
    // ì ìˆ˜ í‘œì‹œ
    const scoreElement = document.getElementById('score');
    if (scoreElement) {
        scoreElement.textContent = score;
    }
    
    // ìƒëª… í‘œì‹œ
    const livesElement = document.getElementById('lives');
    if (livesElement) {
        livesElement.textContent = lives;
    }
    
    // ìŠ¤í…Œì´ì§€ í‘œì‹œ
    const stageElement = document.getElementById('stage');
    if (stageElement) {
        stageElement.textContent = currentStage;
    }
    
    console.log('UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
}

// ê²Œì„ ì¬ì‹œì‘
function restartGame() {
    console.log('ê²Œì„ ì¬ì‹œì‘!');
    startGame();
}

// ê²Œì„ ì¼ì‹œì •ì§€ í† ê¸€
function togglePause() {
    if (!gameRunning) return;
    
    gamePaused = !gamePaused;
    console.log(gamePaused ? 'ê²Œì„ ì¼ì‹œì •ì§€' : 'ê²Œì„ ì¬ê°œ');
}

// ì í”„ í•¨ìˆ˜ (ìºë¦­í„°ë³„ ëŠ¥ë ¥ì¹˜ ì ìš©)
function jump() {
    if (player.onGround && !player.jumping) {
        // ì²« ë²ˆì§¸ ì í”„ (ìºë¦­í„°ë³„ ì í”„ë ¥ ì ìš©)
        const jumpPower = player.jumpPower || JUMP_POWER;
        player.velocityY = -jumpPower;
        player.jumping = true;
        player.onGround = false;
        player.jumpCount = 1;
        
        // ì í”„ íŒŒí‹°í´ ìƒì„±
        createParticle(player.x + player.width/2, player.y + player.height, '#87CEEB');
        
        // ì í”„ íš¨ê³¼ìŒ ì¬ìƒ
        if (audioSystem && audioSystem.playJumpSound) {
            audioSystem.playJumpSound();
        }
        
        console.log(`${player.character} ì²« ë²ˆì§¸ ì í”„! (ì í”„ë ¥: ${jumpPower})`);
    } else if (player.jumping && player.jumpCount < 3) {
        // ë‘ ë²ˆì§¸, ì„¸ ë²ˆì§¸ ì í”„ (ê³µì¤‘ì—ì„œ)
        const baseJumpPower = player.jumpPower || JUMP_POWER;
        const jumpPower = player.jumpCount === 2 ? baseJumpPower * 0.8 : baseJumpPower * 0.6;
        player.velocityY = -jumpPower;
        player.jumpCount++;
        
        // ì í”„ íŒŒí‹°í´ ìƒì„± (ìƒ‰ìƒ êµ¬ë¶„)
        let particleColor;
        if (player.jumpCount === 2) {
            particleColor = '#FFD700'; // ê³¨ë“œ
        } else {
            particleColor = '#FF4500'; // ì˜¤ë Œì§€
        }
        createParticle(player.x + player.width/2, player.y + player.height, particleColor);
        
        console.log(`${player.character} ${player.jumpCount}ë²ˆì§¸ ì í”„! (ì í”„ë ¥: ${jumpPower})`);
    }
}

// í”Œë ˆì´ì–´ ë¦¬ì…‹
function resetPlayer() {
    player.x = 100;
    player.y = 800;
    player.velocityX = 0;
    player.velocityY = 0;
    
    // ì„ íƒëœ ìºë¦­í„°ì˜ ëŠ¥ë ¥ì¹˜ ì ìš©
    const character = CHARACTERS[selectedCharacter];
    if (character) {
        player.character = selectedCharacter;
        player.maxHealth = character.stats.health;
        player.health = character.stats.health;
        player.attackPower = character.stats.attack;
        player.speed = character.stats.speed;
        player.jumpPower = character.stats.jumpPower;
        
        console.log(`ìºë¦­í„° ${selectedCharacter} ëŠ¥ë ¥ì¹˜ ì ìš©: ì²´ë ¥ ${character.stats.health}, ê³µê²©ë ¥ ${character.stats.attack}, ì†ë„ ${character.stats.speed}`);
    } else {
        // ê¸°ë³¸ ëŠ¥ë ¥ì¹˜
        player.character = 'ê¸°ë³¸';
        player.maxHealth = 300;
        player.health = 300;
        player.attackPower = 50;
        player.speed = 6;
        player.jumpPower = 18;
    }
    
    // ë‚œì´ë„ë³„ ëŠ¥ë ¥ì¹˜ ì¡°ì •
    const difficulty = DIFFICULTY_SETTINGS[gameDifficulty];
    player.maxHealth = Math.round(player.maxHealth * difficulty.playerHealth);
    player.health = player.maxHealth;
    
    player.attacking = false;
    player.attackCooldown = 0;
    player.invincible = false;
    player.invincibleTime = 0;
    player.projectiles = []; // ë°œì‚¬ì²´ ë°°ì—´ ì´ˆê¸°í™”
    player.jumpCount = 0; // ì í”„ íšŸìˆ˜ ì´ˆê¸°í™”
    isDashing = false; // ëŒ€ì‹œ ìƒíƒœ ì´ˆê¸°í™”
    
    // ëŒ€í˜• ë¯¸ì‚¬ì¼ ì¿¨ë‹¤ìš´ ì´ˆê¸°í™”
    player.missileCooldown = 0;
}

// ê³µê²© í•¨ìˆ˜ (ìºë¦­í„°ë³„ ê³µê²©ë ¥ ì ìš©)
function attack() {
    // ê³µê²© ì¿¨ë‹¤ìš´ ì²´í¬
    if (player.attackCooldown > 0) return;
    
    player.attacking = true;
    player.attackCooldown = 8; // ê³µê²© ì¿¨ë‹¤ìš´ (0.13ì´ˆ)
    
    // ë°œì‚¬ì²´ ìƒì„± ìœ„ì¹˜ ê³„ì‚°
    let projectileX, projectileY;
    if (player.direction > 0) {
        // ì˜¤ë¥¸ìª½ ë°©í–¥
        projectileX = player.x + player.width;
        projectileY = player.y + player.height / 2;
    } else {
        // ì™¼ìª½ ë°©í–¥
        projectileX = player.x;
        projectileY = player.y + player.height / 2;
    }
    
    // ìºë¦­í„°ë³„ ë°œì‚¬ì²´ íƒ€ì… ê²°ì •
    let projectileType = 'normal';
    let projectileDamage = player.attackPower || 50;
    
    // íŠ¹ìˆ˜ ìºë¦­í„°ë³„ ê³µê²© íš¨ê³¼
    if (player.character === 'ê²€ì‚¬') {
        projectileType = 'sword';
        projectileDamage = Math.round(projectileDamage * 1.2); // ê²€ì‚¬ëŠ” 20% ì¶”ê°€ ë°ë¯¸ì§€
    } else if (player.character === 'ê¶ìˆ˜') {
        projectileType = 'arrow';
        projectileDamage = Math.round(projectileDamage * 1.1); // ê¶ìˆ˜ëŠ” 10% ì¶”ê°€ ë°ë¯¸ì§€
    } else if (player.character === 'ë§ì¹˜ì „ë¬¸ê°€') {
        projectileType = 'hammer';
        projectileDamage = Math.round(projectileDamage * 1.3); // ë§ì¹˜ì „ë¬¸ê°€ëŠ” 30% ì¶”ê°€ ë°ë¯¸ì§€
    } else if (player.character === 'í­íƒ„ì „ë¬¸ê°€') {
        projectileType = 'bomb';
        projectileDamage = Math.round(projectileDamage * 1.4); // í­íƒ„ì „ë¬¸ê°€ëŠ” 40% ì¶”ê°€ ë°ë¯¸ì§€
    }
    
    // ë°œì‚¬ì²´ ìƒì„±
    const projectile = new Projectile(projectileX, projectileY, player.direction, projectileType, projectileDamage);
    player.projectiles.push(projectile);
    
    // ê³µê²© íŒŒí‹°í´ ìƒì„± (ìºë¦­í„°ë³„ ìƒ‰ìƒ)
    let particleColor = '#FFD700'; // ê¸°ë³¸ ê³¨ë“œ
    if (player.character === 'ê²€ì‚¬') particleColor = '#FF4500'; // ë¹¨ê°•
    else if (player.character === 'ê¶ìˆ˜') particleColor = '#00FF00'; // ì´ˆë¡
    else if (player.character === 'ë§ì¹˜ì „ë¬¸ê°€') particleColor = '#8B4513'; // ê°ˆìƒ‰
    else if (player.character === 'í­íƒ„ì „ë¬¸ê°€') particleColor = '#FF0000'; // ë¹¨ê°•
    
    createParticle(projectileX, projectileY, particleColor);
    
    console.log(`${player.character} ê³µê²©! ë°ë¯¸ì§€: ${projectileDamage}, íƒ€ì…: ${projectileType}`);
    
    // ìºë¦­í„°ë³„ ê³µê²© íš¨ê³¼ìŒ ì¬ìƒ
    if (audioSystem) {
        switch (projectileType) {
            case 'sword':
                audioSystem.playSwordSound();
                break;
            case 'arrow':
                audioSystem.playArrowSound();
                break;
            case 'hammer':
                audioSystem.playHammerSound();
                break;
            case 'bomb':
                audioSystem.playBombSound();
                break;
            default:
                audioSystem.playSwordSound(); // ê¸°ë³¸ ê²€ íš¨ê³¼ìŒ
        }
    }
    
    // ê³µê²© ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
    createAttackEffect(projectileX, projectileY);
    
    // ê³µê²© ìƒíƒœë¥¼ ì¦‰ì‹œ í•´ì œí•˜ì—¬ ì—°ì† ê³µê²© ê°€ëŠ¥í•˜ê²Œ í•¨
    setTimeout(() => {
        player.attacking = false;
    }, 100); // 0.1ì´ˆ í›„ ê³µê²© ìƒíƒœ í•´ì œ
}

// ëŒ€í˜• ë¯¸ì‚¬ì¼ ë°œì‚¬ í•¨ìˆ˜
function fireMissile() {
    if (player.missileCooldown > 0) return;
    
    player.missileCooldown = 600; // 10ì´ˆ (60fps * 10)
    
    // ë¯¸ì‚¬ì¼ ìƒì„± ìœ„ì¹˜ ê³„ì‚°
    let missileX, missileY;
    if (player.direction > 0) {
        missileX = player.x + player.width;
        missileY = player.y + player.height / 2;
    } else {
        missileX = player.x;
        missileY = player.y + player.height / 2;
    }
    
    // ëŒ€í˜• ë¯¸ì‚¬ì¼ ìƒì„±
    const missile = new Missile(missileX, missileY, player.direction);
    player.projectiles.push(missile);
    
    // ë¯¸ì‚¬ì¼ ë°œì‚¬ íŒŒí‹°í´ ìƒì„±
    for (let i = 0; i < 15; i++) {
        createParticle(missileX, missileY, '#FF4500', 
            (Math.random() - 0.5) * 8, 
            (Math.random() - 0.5) * 8);
    }
    
    console.log('ëŒ€í˜• ë¯¸ì‚¬ì¼ ë°œì‚¬!');
}

// ê³µê²© ì´í™íŠ¸ ìƒì„±
function createAttackEffect(x, y) {
    // ê³µê²© ì‹œì‘ íŒŒí‹°í´
    for (let i = 0; i < 8; i++) {
        const angle = (i / 8) * Math.PI * 2;
        const velocityX = Math.cos(angle) * 3;
        const velocityY = Math.sin(angle) * 3;
        
        createParticle(x, y, '#FFD700', velocityX, velocityY);
    }
    
    // ê³µê²© ë°©í–¥ íŒŒí‹°í´
    const direction = player.direction;
    for (let i = 0; i < 5; i++) {
        const offsetX = direction * (i * 8);
        const offsetY = (Math.random() - 0.5) * 20;
        
        createParticle(
            x + offsetX, 
            y + offsetY, 
            '#FF4500', 
            direction * 6, 
            (Math.random() - 0.5) * 4
        );
    }
}

// íŒŒí‹°í´ ìƒì„± (í–¥ìƒëœ ë²„ì „)
function createParticle(x, y, color, velocityX = 0, velocityY = 0) {
    particles.push({
        x: x,
        y: y,
        velocityX: velocityX + (Math.random() - 0.5) * 2,
        velocityY: velocityY + (Math.random() - 0.5) * 2,
        color: color,
        life: 30 + Math.random() * 20,
        size: 3 + Math.random() * 3
    });
}

// ë°ë¯¸ì§€ ë°›ê¸° (ê°œì„ ëœ ë²„ì „)
function takeDamage(damage) {
    // ë¬´ì  ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ ë°ë¯¸ì§€ ë°›ê¸°
    if (player.invincible) {
        console.log('ë¬´ì  ìƒíƒœë¡œ ë°ë¯¸ì§€ ë¬´ì‹œ!');
        return;
    }
    
    player.health -= damage;
    if (player.health < 0) player.health = 0;
    
    // ë¬´ì  ìƒíƒœ ì„¤ì • (1ì´ˆê°„)
    player.invincible = true;
    player.invincibleTime = 60; // 60í”„ë ˆì„ = 1ì´ˆ
    
    // ë°ë¯¸ì§€ íŒŒí‹°í´ ìƒì„±
    createParticle(player.x + player.width/2, player.y, '#FF0000');
    
    // í™”ë©´ í”ë“¤ë¦¼ íš¨ê³¼ (ë Œë”ë§ì—ì„œ ì²˜ë¦¬)
    
    console.log(`ë°ë¯¸ì§€ ë°›ìŒ: ${damage}, ë‚¨ì€ ìƒëª…: ${lives}`);
    
    // ì²´ë ¥ì´ 0ì´ ë˜ë©´ ìƒëª… ê°ì†Œ
    if (player.health <= 0) {
        loseLife();
    }
    
    updateUI();
}

// ì²´ë ¥ íšŒë³µ í•¨ìˆ˜
function healPlayer(amount) {
    player.health = Math.min(player.health + amount, player.maxHealth);
    
    // íšŒë³µ íŒŒí‹°í´ ìƒì„±
    for (let i = 0; i < 10; i++) {
        createParticle(player.x + player.width/2, player.y, '#00FF00');
    }
    
    console.log(`ì²´ë ¥ íšŒë³µ: +${amount}, í˜„ì¬ ì²´ë ¥: ${player.health}`);
    updateUI();
}

// ìƒëª… ê°ì†Œ
function loseLife() {
    lives--;
    console.log(`ìƒëª… ê°ì†Œ! ë‚¨ì€ ìƒëª…: ${lives}`);
    
    if (lives <= 0) {
        gameOver();
    } else {
        // í”Œë ˆì´ì–´ ìœ„ì¹˜ ì¬ì„¤ì •
        resetPlayer();
        
        // ìŠ¤í…Œì´ì§€ ì¬ìƒì„±
        generateStage();
        
        updateUI();
    }
}

// ê²Œì„ ì˜¤ë²„
function gameOver() {
    console.log('ê²Œì„ ì˜¤ë²„!');
    gameRunning = false;
    
    // ê²Œì„ ì˜¤ë²„ íš¨ê³¼ìŒ ì¬ìƒ
    if (audioSystem && audioSystem.playGameOverSound) {
        audioSystem.playGameOverSound();
    }
    
    // ê²Œì„ ë°°ê²½ìŒì•… ì¤‘ì§€
    if (audioSystem && audioSystem.stopBGM) {
        audioSystem.stopBGM();
    }
    
    // ìµœì¢… ì ìˆ˜ ì„¤ì •
    const finalScore = document.getElementById('finalScore');
    const finalStage = document.getElementById('finalStage');
    
    if (finalScore) finalScore.textContent = score;
    if (finalStage) finalStage.textContent = currentStage;
    
    // ê²Œì„ ì˜¤ë²„ í™”ë©´ í‘œì‹œ
    const gameOverScreen = document.getElementById('gameOverScreen');
    if (gameOverScreen) gameOverScreen.style.display = 'block';
}

// ê²Œì„ ì¬ì‹œì‘
function restartGame() {
    console.log('ê²Œì„ ì¬ì‹œì‘!');
    
    // ê²Œì„ ì˜¤ë²„ í™”ë©´ ìˆ¨ê¸°ê¸°
    const gameOverScreen = document.getElementById('gameOverScreen');
    if (gameOverScreen) gameOverScreen.style.display = 'none';
    
    // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
    score = 0;
    lives = 5;
    currentStage = 1;
    currentPlanet = 1;
    gameTime = 0;
    isNightMode = false;
    nightModeTimer = 0;
    lastTimeTransition = 0;
    bossStage = false;
    bossDefeated = false;
    
    // ê²Œì„ ì‹œì‘
    startGame();
}

// ì»¨íŠ¸ë¡¤ ê°€ì´ë“œ í‘œì‹œ
function showControlGuide() {
    const guide = `
ğŸ® **ê²Œì„ ì»¨íŠ¸ë¡¤ ê°€ì´ë“œ**

**ì´ë™:**
- A / â†: ì™¼ìª½ ì´ë™
- D / â†’: ì˜¤ë¥¸ìª½ ì´ë™
- ìŠ¤í˜ì´ìŠ¤ë°”: ì í”„ (3ë‹¨ ì í”„ ê°€ëŠ¥!)
- S: ëŒ€ì‹œ (ë¹ ë¥¸ ì´ë™)

**ì•¡ì…˜:**
- F: ë¬´ê¸° ë°œì‚¬ (ê³¨ë“œ ë°œì‚¬ì²´, ì—°ì† ë°œì‚¬!)
- E: ëŒ€í˜• ë¯¸ì‚¬ì¼ (ê´‘ì—­ ë°ë¯¸ì§€, 10ì´ˆ ì¿¨ë‹¤ìš´!)
- P: ì¼ì‹œì •ì§€
- F11: ì „ì²´í™”ë©´ í† ê¸€

**ì „ì²´í™”ë©´:**
- ìš°ì¸¡ ìƒë‹¨ â›¶ ë²„íŠ¼ í´ë¦­
- ë˜ëŠ” F11 í‚¤ ì‚¬ìš©

**ê²Œì„ ì‹œìŠ¤í…œ:**
- Fí‚¤ë¡œ ì ì„ ì—°ì† ê³µê²©í•˜ì„¸ìš”! (0.13ì´ˆë§ˆë‹¤!)
- Eí‚¤ë¡œ ëŒ€í˜• ë¯¸ì‚¬ì¼ì„ ë°œì‚¬í•˜ì„¸ìš”! (ê´‘ì—­ ë°ë¯¸ì§€!)
- ë°œì‚¬ì²´ê°€ ì ì—ê²Œ ë§ìœ¼ë©´ í­ë°œ íš¨ê³¼ì™€ í•¨ê»˜ ë°ë¯¸ì§€!
- 3ë‹¨ ì í”„ë¡œ ë” ë†’ì€ ê³³ìœ¼ë¡œ ì´ë™ ê°€ëŠ¥!
- Sí‚¤ë¡œ ëŒ€ì‹œí•˜ì—¬ ë¹ ë¥´ê²Œ ì´ë™!
- ì ì„ ë¬¼ë¦¬ì¹˜ê³  ì½”ì¸ì„ ëª¨ìœ¼ì„¸ìš”!
- ìŠ¤í…Œì´ì§€ ì§„í–‰ë„ê°€ 100%ê°€ ë˜ë©´ ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ!
- ì²´ë ¥ì´ 0ì´ ë˜ë©´ ìƒëª…ì´ ê°ì†Œí•©ë‹ˆë‹¤
- ë¬´ì  ì‹œê°„ ë™ì•ˆì€ ì¶”ê°€ ë°ë¯¸ì§€ë¥¼ ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤
- ì²´ë ¥ íšŒë³µ ì•„ì´í…œì„ ë¨¹ì–´ ì²´ë ¥ì„ íšŒë³µí•˜ì„¸ìš”!

**ë³´ìŠ¤ ì‹œìŠ¤í…œ:**
- 5ìŠ¤í…Œì´ì§€ë§ˆë‹¤ ê°•ë ¥í•œ ë³´ìŠ¤ ë“±ì¥!
- ë³´ìŠ¤ë¥¼ ì²˜ì¹˜í•˜ë©´ ë‹¤ìŒ êµ¬ê°„ìœ¼ë¡œ ì§„í–‰!
- ë³´ìŠ¤ëŠ” ì¼ë°˜ ì ë³´ë‹¤ í›¨ì”¬ ê°•ë ¥í•©ë‹ˆë‹¤!

**ì  AI (ê°•í™”ë¨!):**
- í”Œë ˆì´ì–´ê°€ ê°€ê¹Œìš°ë©´ ì¶”ì  ëª¨ë“œë¡œ ì „í™˜ (ë²”ìœ„ í™•ì¥!)
- ì¤‘ê°„ ê±°ë¦¬ì—ì„œëŠ” ê²½ê³„ ëª¨ë“œ
- ë©€ë¦¬ ìˆìœ¼ë©´ ìˆœì°° ëª¨ë“œë¡œ ëœë¤ ì´ë™
- ì ë“¤ë„ ì í”„ë¥¼ í•©ë‹ˆë‹¤!
- ì›ê±°ë¦¬ ê³µê²© ì , í­ë°œ ì  ë“± ë‹¤ì–‘í•œ ì  ë“±ì¥!

**ê²Œì„ ëª©í‘œ:**
- ë†’ì€ ì ìˆ˜ë¥¼ ê¸°ë¡í•˜ì„¸ìš”!
- ìµœëŒ€í•œ ë§ì€ ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í•˜ì„¸ìš”!
- ì—°ì† ê³µê²©ìœ¼ë¡œ ì ë“¤ì„ ë¬¼ë¦¬ì¹˜ì„¸ìš”!
- ë³´ìŠ¤ë¥¼ ì²˜ì¹˜í•˜ì—¬ ë‹¤ìŒ êµ¬ê°„ìœ¼ë¡œ ì§„í–‰í•˜ì„¸ìš”!
    `;
    
    alert(guide);
}

// ê²Œì„ ë£¨í”„
function gameLoop() {
    if (!gameRunning) return;
    
    if (!gamePaused) {
        // ì‹œê°„ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
        updateTimeSystem();
        
        // ì—…ë°ì´íŠ¸
        updatePlayer();
        updateEnemies();
        updateCoins();
        updateProjectiles();
        updateExplosions();
        updateParticles();
        updateStageProgress();
        
        // ë Œë”ë§
        renderGame();
    }
    
    // ë‹¤ìŒ í”„ë ˆì„ ìš”ì²­
    requestAnimationFrame(gameLoop);
}

// ì‹œê°„ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
function updateTimeSystem() {
    gameTime += 1/60; // 60fps ê¸°ì¤€ìœ¼ë¡œ ì‹œê°„ ì¦ê°€
    
    // 30ì´ˆë§ˆë‹¤ ì‹œê°„ ì „í™˜ ì‹œë„ (10% í™•ë¥ )
    if (gameTime - lastTimeTransition > 30 && Math.random() < 0.1) {
        toggleTimeMode();
        lastTimeTransition = gameTime;
    }
    
    // ì €ë… ëª¨ë“œ ì§€ì† ì‹œê°„ ê´€ë¦¬
    if (isNightMode) {
        nightModeTimer += 1/60;
        
        // 20ì´ˆ í›„ ë‚® ëª¨ë“œë¡œ ë³µê·€
        if (nightModeTimer > 20) {
            toggleTimeMode();
        }
    }
}

// ì‹œê°„ ëª¨ë“œ ì „í™˜ (ë‚®/ì €ë…)
function toggleTimeMode() {
    isNightMode = !isNightMode;
    
    if (isNightMode) {
        // ì €ë… ëª¨ë“œ ì‹œì‘
        console.log('ğŸŒ™ ì €ë… ëª¨ë“œ ì‹œì‘! ì ë“¤ì´ ê°•í•´ì§‘ë‹ˆë‹¤!');
        
        // ëª¨ë“  ì ë“¤ì„ ê°•í™”
        enemies.forEach(enemy => {
            enemy.health = Math.round(enemy.health * 1.5); // ì²´ë ¥ 50% ì¦ê°€
            enemy.attackPower = Math.round(enemy.attackPower * 1.3); // ê³µê²©ë ¥ 30% ì¦ê°€
            enemy.velocityX = enemy.velocityX * 1.2; // ì†ë„ 20% ì¦ê°€
        });
        
        // ì €ë… ëª¨ë“œ íš¨ê³¼ìŒ ì¬ìƒ
        if (audioSystem && audioSystem.playMagicSound) {
            audioSystem.playMagicSound();
        }
        
        // ì €ë… ëª¨ë“œ íŒŒí‹°í´ íš¨ê³¼
        for (let i = 0; i < 50; i++) {
            createParticle(
                Math.random() * canvas.width,
                Math.random() * canvas.height,
                '#4B0082', // ë³´ë¼ìƒ‰
                (Math.random() - 0.5) * 2,
                (Math.random() - 0.5) * 2
            );
        }
        
    } else {
        // ë‚® ëª¨ë“œë¡œ ë³µê·€
        console.log('â˜€ï¸ ë‚® ëª¨ë“œë¡œ ë³µê·€! ì ë“¤ì´ ì›ë˜ëŒ€ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
        
        // ëª¨ë“  ì ë“¤ì„ ì›ë˜ëŒ€ë¡œ ë³µì›
        enemies.forEach(enemy => {
            enemy.health = Math.round(enemy.health / 1.5);
            enemy.attackPower = Math.round(enemy.attackPower / 1.3);
            enemy.velocityX = enemy.velocityX / 1.2;
        });
        
        // ë‚® ëª¨ë“œ íš¨ê³¼ìŒ ì¬ìƒ
        if (audioSystem && audioSystem.playPowerUpSound) {
            audioSystem.playPowerUpSound();
        }
        
        // ë‚® ëª¨ë“œ íŒŒí‹°í´ íš¨ê³¼
        for (let i = 0; i < 30; i++) {
            createParticle(
                Math.random() * canvas.width,
                Math.random() * canvas.height,
                '#FFD700', // ê³¨ë“œ
                (Math.random() - 0.5) * 3,
                (Math.random() - 0.5) * 3
            );
        }
    }
    
    nightModeTimer = 0;
}

// ê²Œì„ ì‹œì‘
console.log('ê²Œì„ í•µì‹¬ ë¡œì§ (ë³´ìŠ¤ ì‹œìŠ¤í…œ ë° ëŒ€í˜• ë¯¸ì‚¬ì¼ êµ¬í˜„ ë²„ì „) ë¡œë“œ ì™„ë£Œ!');

// ì „ì—­ í•¨ìˆ˜ë“¤ì„ ëª…ì‹œì ìœ¼ë¡œ ë…¸ì¶œ
window.setupGame = setupGame;
window.startGame = startGame;
window.restartGame = restartGame;
window.togglePause = togglePause;
window.initPlayer = initPlayer;
window.initStage = initStage;
window.gameLoop = gameLoop;
window.setupEventListeners = setupEventListeners;
window.initFullscreen = initFullscreen;
window.showStartScreen = showStartScreen;

// í•¨ìˆ˜ ì¡´ì¬ í™•ì¸ ë° ë¡œê¹…
const requiredFunctions = [
    'setupGame', 'startGame', 'restartGame', 'togglePause',
    'initPlayer', 'initStage', 'gameLoop', 'setupEventListeners',
    'initFullscreen', 'showStartScreen'
];

console.log('=== ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ ìƒíƒœ í™•ì¸ ===');
requiredFunctions.forEach(funcName => {
    if (typeof window[funcName] === 'function') {
        console.log(`âœ… ${funcName}: í•¨ìˆ˜ ë¡œë“œë¨`);
    } else {
        console.error(`âŒ ${funcName}: í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
    }
});

console.log('=== ì‚¬ìš© ê°€ëŠ¥í•œ ì „ì—­ í•¨ìˆ˜ë“¤ ===');
const availableFunctions = Object.keys(window).filter(key => typeof window[key] === 'function');
console.log(availableFunctions);

// ê²Œì„ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ ì•Œë¦¼
console.log('ğŸ® ê²Œì„ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ! ëª¨ë“  í•¨ìˆ˜ê°€ ì „ì—­ì— ë…¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');